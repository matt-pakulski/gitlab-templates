# Tests mirroring from one gitlab repo to another gitlab repo using https
#
# Job 'push-commit:gitlab-https-to-gitlab-https' clones the source repo, creates a commit to it, and pushes the repo
# Job 'gitlab-https-to-gitlab-https' performs the clone from the source repo to the target repo (located in examples/ directory)
# Job 'verify:gitlab-https-to-gitlab-https' verifies that the commit that was added to the source repo is present in the target repo


.default_variables:gitlab-https-to-gitlab-https: &default_variables
  SOURCE_REPO_URL: https://$CI_SERVER_FQDN/$CI_PROJECT_NAMESPACE/gitlab-clone-testing/mirror-from-gitlab-https-to-gitlab-https/source.git
  TARGET_REPO_URL: https://$CI_SERVER_FQDN/$CI_PROJECT_NAMESPACE/gitlab-clone-testing/mirror-from-gitlab-https-to-gitlab-https/target.git


push-commit:gitlab-https-to-gitlab-https:
  extends: .clone-repo
  stage: build

  variables:
    <<: *default_variables
    CLONE_REPO_URL: $SOURCE_REPO_URL
    SOURCE_HTTP_USERNAME: git
    SOURCE_HTTP_PASSWORD: $GITLAB_TARGET_REPO_TOKEN # defined in gitlab ui
  
  script:
    - cd cloned_repo.git
    - !reference [.git-mirroring:tests:snippets, configure git commit user]
    - !reference [.git-mirroring:tests:snippets, create a commit]
    - git push
    - echo "COMMIT_HASH=$(git rev-parse HEAD)" > ${CI_PROJECT_DIR}/.env
  
  artifacts:
    reports:
      dotenv: .env


verify:gitlab-https-to-gitlab-https:
  extends: .clone-repo
  stage: test
  needs: 
    - push-commit:gitlab-https-to-gitlab-https
    - gitlab-https-to-gitlab-https

  variables:
    <<: *default_variables
    CLONE_REPO_URL: $TARGET_REPO_URL

  script:
    - cd cloned_repo.git
    - |
      if [ "$COMMIT_HASH" != "$(git rev-parse HEAD)" ]; then
        echo "Commit hashes do not match!"
        echo ".env:COMMIT_HASH: $COMMIT_HASH"
        echo "HEAD:COMMIT_HASH: $(git rev-parse HEAD)"
        exit 1
      else
        echo "Commit hashes match. Repository has been mirrored from source to target."
      fi
